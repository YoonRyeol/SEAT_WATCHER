<!DOCTYPE html>
<html>
<head>
	<meta charset="uft-8">
	<meta name="viewprot" content="width=device-width, inital-scale=1, shrinkt-to-fit=no">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

	<link rel="stylesheet" type="text/css" href="/static/css/footer.css">
	<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="/static/css/Camera_list.css">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/js/bootstrap.min.js" integrity="sha384-XEerZL0cuoUbHE4nZReLT7nx9gQrQreJekYhJD9WNWhH8nEW+0c5qq7aIo2Wl30J" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

	<title>WATCHER</title>


</head>
<body>
	<!--내비게이션 바-->
	<nav class="navbar navbar-expand-lg navbar-light" style="background-color:black;">
		<a class="navbar-brand" href="{% url 'watcher:store_info' %}" style="color : white; ">WATCHER</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<div class="navbar-nav">
				<li><a href="#" style="text-decoration: none; color:white;">홈 화면 <span class="sr-only">(current)</span></a></li>
			</div>
		 </div>
	</nav>

	<div class="wrap">


		<div class="container-fluid title">
		<h2>매장 목록</h2>
		<p class="text-left">현재 관리되고 있는 매장 목록입니다.</p>
		</div>

		<button style="float :left; margin-left : 1%;" id="store_add_button" data-toggle="modal" data-target="#modal_store_add" type="button" class="btn btn-dark">매장 추가</button>
	

		<!--카메라 리스트 테이블 시작 -->
		<!--검색창-->
		<div class="container-fluid"> 
			
			<div class="input-group mb-3" style="width:25%; float:right;">
				<input type="text" id="keyword" class="form-control" placeholder="검색 내용" aria-label="검색 내용" aria-describedby="button-addon2">
				<div class="input-group-append" style="background-color: #343a40; border-top-right-radius: 0.3em; border-bottom-right-radius: 0.3em; min-width:18%; width:18%;">
					<i type="button" id="button-addon2" class="fa fa-search fa-lg fa-fw" style="display:block; width:100%; padding-top:10px; color:white;"></i>
				</div>
			</div>
			
			
		</div>
	
		

		<div class="table-responsive" style="height : 55vh; overflow: scroll;" >
		<!-- Table -->
			<table class="table table-striped table-bordered table-dark table-hover">
				<thead class="thead-light">
					<tr >
						<th style="position:sticky; top:0;" data-column-id ="numeric" class="th-sm">#</th>
						<th style="position:sticky; top:0;" data-column-id ="name" class="th-sm">매장 이름</th>
						<th style="position:sticky; top:0;" data-column-id ="location" class="th-sm">매장 위치</th>
						<th style="position:sticky; top:0;" data-column-id ="edit" class="th-sm">편집</th>
					</tr>
				</thead>
				
				<tbody id ="tbody_store">
				{% for list in store_list %}
				<tr id="tr_store_list_{{list.pk}}">
					<input type="hidden" data-pk="{{list.pk}}" data-store_name="{{list.store_name}}" data-store_location="{{list.store_location}}" data-picture_name="{{list.picture_name}}">
					<td>
						<a href ="store_info/{{list.pk}}/"><i type="button" style="color:white; margin:4px;" class="fa fa-home" ></i></a>{{list.pk}}
					</td>
					<td><i class="fa fa-store"></i>{{list.store_name}}</td>
					<td>{{list.store_location}}</td>
					<td><i type="button" id="td_store_edit_button_{{list.pk}}" name="td_store_edit_button" data-pk="{{list.pk}}" data-store_name="{{list.store_name}}" data-store_location="{{list.store_location}}" data-picture_name="{{list.picture_name}}" data-toggle="modal" data-target="#modal_store_edit"  style="margin:4px" class="fa fa-edit" ></i><i type="button" id="td_store_delete_button" name="{{list.pk}}" style="margin:4px" class="fa fa-trash"></i></td>
				</tr>
				{% endfor %}
  				</tbody>
  			</table>
  			
  		</div><!--container-fluid-->
  		<!--카메라 리스트 테이블 끝-->
  	</div>
  	</div><!--wrap-->

	<!--footer-->
	<footer>
		<div class="container">
					<br>
					<div class="row">
						<div id="footer_copyright" class="col-sm-4" ><h5>Copyright &copy; 2020</h5>
							<ul>
							<li><h5>김민호(KIM MINHO)</h5></li>
							<li><h5>박지범(PARK JIBEOM)</h5></li>
							<li><h5>윤 렬(YOON RYEOL)</h5></li>
							</ul>
						</div>
						<div class="col-sm-4" ><h4>소개</h4><p>숭실대학교 프로젝트 팀 정도(正道)</p></div>
						<div class="col-sm-4"><h4>위치</h4><p>서울특별시 동작구 상도동 숭실대학교</p></div>
					</div>
				</div>
	</footer>

	<!--가게 추가 모달 -->
		<div class="modal fade" id="modal_store_add" tabindex="-1" role="dialog" aria-labelledby="modal_store_add_lable" aria-hidden="true">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="modal_store_add_label">매장 추가</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <form method="post" id = "modal_store_add_form">
		          <div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 18%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;">매장 이름</span>
						</div>
						  <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" id="modal_store_add_name">
					</div>
					<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 18%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align:center;" >매장 위치</span>
						</div>
						  <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" id="modal_store_add_location">
					</div>

					<div class="input-group input-group-sm mb-3" >
						<input type="file" name="modal_add_pic_file" id="modal_store_add_picturename" accept="image/*">
					</div>

		        </form>
		      </div>
		      <div class="modal-footer">
		        <button type="button" id="modal_store_add_close_btn" class="btn btn-secondary" data-dismiss="modal" onClick="modal_store_init()">닫기</button>
		        <button type="button" id="modal_store_add_btn" data-dismiss="modal" class="btn btn-primary">매장 추가</button>
		      </div>
		    </div>
		  </div>
		</div>

	<!--가게 수정 모달 -->
		<div class="modal fade" id="modal_store_edit" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="modal_store_edit_label"></h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <form method="post" id="modal_store_edit_form">
		        	<div class="input-group input-group-sm mb-3" >
		        		<div class="input-group-prepend" style="width : 18%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;">매장 이름</span>
						</div>
						  <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" id="modal_store_edit_name">
					</div>
					<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 18%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align:center;" >매장 위치</span>
						</div>
						  <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" id="modal_store_edit_location">
					</div>
					  
					  <div class="input-group input-group-sm mb-3" >
						<input type="file" name="modal_edit_pic_file" id="modal_store_edit_picturename" accept="image/*">
					  </div>
					

		        </form>
		      </div>
		      <div class="modal-footer">
		        <button type="button" id="modal_store_edit_close_btn" class="btn btn-secondary" data-dismiss="modal">닫기</button>
		        <button type="button" id="modal_store_edit_btn" data-dismiss="modal" class="btn btn-primary">수정 및 저장</button>
		      </div>
		    </div>
		  </div>
		</div>

		<!--모달 form 끝-->

<script>
	var mutex_file = 0;

	/* 가게리스트 만드는 함수*/
	function create_store_list(data) {
		$('#tbody_store').empty();
		for(var i =0; i < data.length; i++) {
			create_store_info(data[i]);
		}
	}

	function create_store_info(data) {
		$('#tbody_store').append('<tr id="tr_store_list_'+data.pk+'"><input type="hidden" data-pk="'+data.pk+'" data-store_name="'+data.store_name+'" data-store_location="'+data.store_location+'" data-picture_name="'+data.picture_name+'"><td><a href="store_info/'+data.pk+'/""><i type="button" style="color:white; margin:4px;" class="fa fa-home"></i></a>'+data.pk+'</td><td><i class="fa fa-store"></i>'+data.store_name+'</td><td>'+data.store_location+'</td><td><i type="button" id="td_store_edit_button_'+data.pk+'" name="td_store_edit_button" data-pk="'+data.pk+'" data-store_name="'+data.store_name+'" data-store_location="'+data.store_location+'" data-picture_name="'+data.picture_name+'" data-toggle="modal" data-target="#modal_store_edit"  style="margin:4px" class="fa fa-edit" ></i><i type="button" id="td_store_delete_button" name="'+data.pk+'" style="margin:4px" class="fa fa-trash"></i></td></tr>');
	}
	
		/*가게 테이블 리스트 삭제*/
		$(document).on('click', '#td_store_delete_button', function(e) {
			if(confirm("가게를 삭제 하시겠습니까?")){
				var pk =$(this).attr('name');
				console.log(pk);
				$.ajax({
					url : "{% url 'watcher:ajax_delete_store_info' %}",
					type : 'GET',
					data : {
						'pk' : pk,
					},
					success : function(data) {
						$('#tr_store_list_'+pk).remove();
						
					},
					error: function(error){
						alert('td_store_edit_button error; ' + eval(error));
					}
				});
				return true;
			}
			else {
				return false;
			}
		});


		$('#modal_store_edit_picturename').on('change',function(){
			mutex_file = 1;
		})

		$('#modal_store_add_picturename').on('change',function(){
			mutex_file = 1;
		})

		/*가게 정보 수정 버튼 */
		$(document).on('click', 'i[name=td_store_edit_button]', function(e){
			$('#modal_store_edit_label').text($(this).attr('data-store_name'));
			$('#modal_store_edit_name').val($(this).attr('data-store_name'));
			$('#modal_store_edit_name').attr('name',$(this).attr('data-pk'));
			$('#modal_store_edit_location').val($(this).attr('data-store_location'));
		});
			/*가게 정보 수정 모달에서 저장버튼*/
			$(document).on('click', '#modal_store_edit_btn',function(e) {
				var formData = new FormData();
				var pk = $('#modal_store_edit_name').attr('name');
				var store_name = $('#modal_store_edit_name').val();
				var store_location = $('#modal_store_edit_location').val();
				var files;
				var picture_name = $('#td_store_edit_button_'+pk).attr('data-picture_name');

				if(mutex_file) {
					console.log("mutex changed");
					files = $('input[name=modal_edit_pic_file')[0].files[0]; 
					picture_name = files.name;
					mutex_file = 0;
				}
				
				console.log("picname : "+picture_name);
				
				formData.append('csrfmiddlewaretoken','{{ csrf_token }}');
				formData.append('store_name',store_name);
				formData.append('store_location',store_location);
				formData.append('picture_name',picture_name);
				formData.append('img',files);
				formData.append('pk',pk);


				console.log("pk : "+pk);
				console.log(formData.getAll('pk'));

				if(confirm("변경사항을 저장 하시겠습니까?")){
					$.ajax({
						url : "{% url 'watcher:ajax_edit_store_info' %}",
						type : 'POST',
						dataType : 'json',
						contentType : false,
						processData : false,
						data : formData,
						success : function(data) {
							create_store_list(data);
						},
						error : function(error) {

						},
					});
					return true;
				}
				else{
					return false;
				}
			});

		/*가게 추가 기능 in 모달 */
		$(document).on('click', '#modal_store_add_btn', function(e) {
			var formData = new FormData();
			var files;
			var store_name = $('#modal_store_add_name').val();
			var store_location = $('#modal_store_add_location').val();
			var picture_name;

			if(mutex_file) {
					console.log("mutex changed");
					files = $('input[name=modal_add_pic_file')[0].files[0]; 
					picture_name = files.name;
					mutex_file = 0;
			}

			formData.append('csrfmiddlewaretoken','{{ csrf_token }}')
			formData.append('store_name',store_name);
			formData.append('store_location',store_location);
			formData.append('picture_name',picture_name);
			formData.append('img',files);

			if (confirm('정말 추가 하시겠습니까?')) {				
				
				$.ajax({
					url: "{% url 'watcher:ajax_add_store_list' %}",
					contentType : false,
					processData : false,
					dataType:'json',
					type : 'POST',
					data : formData,
					success: function(data) {
						console.log("save")
						console.log("pk :"+data.pk)
						create_store_info(data);
					},
					error: function (error) {
						alert('error; ' + eval(error));
					}
				});
				return true;
			}
			else
			{
				return false;
			}

		
		});


		$('#modal_store_add').on('hidden.bs.modal', function (e) {
			console.log("modal_close");
		})

		/*카메라 추가 모달 데이터 초기화 */
		function modal_store_init() {
			$('#modal_store_add_name').val('');
			$('#modal_store_add_location').val('');
		}

		$(document).on('keydown', function(e) {
				if (e.keyCode == 27) {modal_store_init();}
			});



	 	/*검색기능*/
		$(document).ready(function(){
			$("#keyword").on("keyup", function() {
				var value = $(this).val().toLowerCase();
				$("#tbody_store tr").filter(function() {
					$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
				});
			});
		});

		$('#footer_copyright>ul').hide();
  		$(document).on('mouseleave', 'footer',function(e){
  				$('#footer_copyright>ul').hide();
  		});
  		$(document).on('mouseenter', 'footer',function(e){
  				$('#footer_copyright>ul').show();
  		});


  		/*이미지 업로드*/

  		$(document).ready(function(){
  			var picture_name
  			$('#modal_store_add_picturename').on('change',function(){
  				console.log('fileupload');
  				$.ajax({
  					url : "{% url 'watcher:ajax_upload_store_img' %}",
  					Type : 'GET',
  					data : {
  						'picture_name' : picture_name,
  					},
					success: function(data) {
						console.log(data);
					},
					error: function (error) {
						alert('이미지저장실패' + eval(error));
					}
  				});
  			});
  		});
	</script>
</script>
</body>
</html>