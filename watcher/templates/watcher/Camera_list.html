<!DOCTYPE html>
<html lang="kr">
<head>
	<meta charset="uft-8">
	<meta name="viewprot" content="width=device-width, inital-scale=1, shrinkt-to-fit=no">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	
	<link rel="stylesheet" type="text/css" href="/static/css/footer.css">
	<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="/static/css/Camera_list.css">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/js/bootstrap.min.js" integrity="sha384-XEerZL0cuoUbHE4nZReLT7nx9gQrQreJekYhJD9WNWhH8nEW+0c5qq7aIo2Wl30J" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

	<title>WATCHER</title>

	<style>
		.clickable{
			cursor: pointer;
		}
	</style>

</head>
<body>
	<!--내비게이션 바-->
	<nav class="navbar navbar-expand-lg navbar-light" style="background-color:black;">
		<a class="navbar-brand" href="#" style="color :white; ">WATCHER</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<div class="navbar-nav">
				<ul class="nav navber-nav">
					<li><a href="#" style="text-decoration: none;">홈 화면 <span class="sr-only">(current)</span></a></li>
					<li><a href="{% url 'watcher:store_info' %}" style="text-decoration: none;">가게 목록</a></li> <!-- 수정필요 -->
					<li ><a href="#" style="text-decoration: none;" ">가게 배치도</a></li>
				</ul>

			</div>
		 </div>
	</nav>

	<div class="wrap">


		<div class="container-fluid title">
		<h2>{{store.store_name}} 매장 정보 </h2>
		<p class="text-left">매장에 설치된 카메라 목록입니다.</p>
		</div>

		
	
		<!--카메라 테이블 시작-->
		<button style="float :left; margin-left : 1%; " id="add_button" data-toggle="modal" data-target="#modal_camera_add" type="button" class="btn btn-dark">카메라 추가</button>

		<div class="container-fluid" style=""> 
			<div class="input-group mb-3" style="width:25%; float:right;">
				<input type="text" id="keyword" class="form-control" placeholder="검색 내용" aria-label="검색 내용" aria-describedby="button-addon2">
				<div class="input-group-append" style="background-color: #343a40; border-top-right-radius: 0.3em; border-bottom-right-radius: 0.3em; min-width:18%; width:18%;">
					<i type="button" id="button-addon2" class="fa fa-search fa-lg fa-fw" style="display:block; width:100%; padding-top:10px; color:white;"></i>
				</div>
			</div>
		</div>

		<div class="table-responsive" style="height : 25vh; overflow: scroll;" >
		<!-- Table -->
			<table class="table table-striped table-bordered table-dark table-hover">
				<thead class="thead-light">
					<tr>
						<th style="position:sticky; top:0;" data-column-id ="numeric" class="th-sm">#</th>
						<th style="position:sticky; top:0;" data-column-id ="available" class="th-sm">이용 여부</th>
						<th style="position:sticky; top:0;" data-column-id ="mac-address" class="th-sm">Mac Address</th>
						<th style="position:sticky; top:0;" data-column-id ="description" class="th-sm">설명</th>
						<th style="position:sticky; top:0;" data-column-id ="edit" class="th-sm">편집</th>
					</tr>
				</thead>
				
				<tbody id="tbody_camera" name="{{store.pk}}"> <!--store_id 저장-->
					{% for list in camera_list%}
					<tr id="tr_list_{{list.pk}}">
						<input type="hidden" data-pk="{{list.pk}}" data-cur_pic="{{list.cur_pic}}" data-mac_addr="{{list.mac_addr}}" data-cur_host="{{list.cur_host}}" data-description="{{list.description}}" data-store_id="{{list.store_id}}" data-floor_id="{{list.floor_id}}">
						<td  class="clickable" onclick='move_page(this)' link="camera/{{list.pk}}" >
							<i style="margin:4px" class="fa fa-camera"></i>
							<a href= "{% url 'watcher:table_set' store.pk list.pk %}" style="color:white;">{{list.pk}}</a>
						</td>
						<td class="td_camera_{{list.pk}}"> </td>
  						<td>{{list.mac_addr}}</td>
  						<td>{{list.description}}</td>
  						<td><i type="button" name="{{list.pk}}" data-toggle="modal" data-target="#modal_camera_edit" style="margin:4px" class="fa fa-edit" id="td_camera_edit_button"><input type="hidden" name= "{{list.pk}}"></i><i style="margin:4px" class="fa fa-trash" name= "{{list.pk}}" id="td_camera_delete_button"></i></td>
  					</tr>
  					{% endfor %}
  					

  				</tbody>
  			</table>
  			
  		</div><!--container-fluid-->
  		<!-- 카메라 테이블 끝 -->

  		<button style="float :left; margin-top: 1%; margin-left : 1%; margin-bottom : 0.5%" id="add_floor_button" data-toggle="modal" data-target="#modal_floor" type="button" class="btn btn-dark" name="{{store.pk}}">층 추가</button>
  		
  		<!--가게층 정보 리스트 테이블 시작 -->
		<div class="table-responsive" style="height : 25vh; overflow: scroll;" >
		<!-- Table -->
			<table class="table table-striped table-bordered table-dark table-hover">
				<thead class="thead-light">
					<tr>
						<th style="position:sticky; top:0;" data-column-id ="th_floor_num" class="th-sm">층</th>
						<th style="position:sticky; top:0;" data-column-id ="th_floor_name" class="th-sm">층 이름</th>
						<th style="position:sticky; top:0;" data-column-id ="th_description" class="th-sm">설명</th>
						<th style="position:sticky; top:0;" data-column-id ="th_edit" class="th-sm">편집</th>
					</tr>
				</thead>
				<tbody id="tbody_floor" name="{{store.pk}}"> <!--store_id 저장-->
					{% for list in floor_list%}
					<tr id="table_floor_tr_{{list.pk}}" data-store_id="{{store.pk}}">
						<input type="hidden" data-pk="{{list.pk}}" data-name="{{list.name}}" data-num="{{list.floor_num}}" data-store_id="{{list.store_id}}" data-description="{{list.description}}" >
						<td>{{list.floor_num}}</td>
  						<td>{{list.name}}</td>
  						<td>{{list.description}}</td>
  						<td><i type="button" name="{{list.pk}}" data-toggle="modal" data-target="#modal_floor_edit"  style="margin:4px" class="fa fa-edit" id="td_floor_edit_button"><input type="hidden" name= "{{list.pk}}"></i><i type="button" style="margin:4px" class="fa fa-trash" name= "{{list.pk}}" id="td_floor_delete_button"></i></td>
  					</tr>
  					{% endfor %}
  					

  				</tbody>
  			</table>
  			
  		</div><!--container-fluid-->
  		<!--가게층 정보 리스트 테이블 끝-->

</div>

  	</div><!--wrap-->
	<!--footer-->
	<footer >
		<div class="container">
					<br>
					<div class="row">
						<div id="footer_copyright" class="col-sm-4" ><h5>Copyright &copy; 2020</h5>
							<ul>
							<li><h5>김민호(KIM MINHO)</h5></li>
							<li><h5>박지범(PARK JIBEOM)</h5></li>
							<li><h5>윤 렬(YOON RYEOL)</h5></li>
							</ul>
						</div>
						<div class="col-sm-4" ><h4>소개</h4><p></p></div>
						<div class="col-sm-4"><h4>위치</h4><p>서울특별시 동작구 상도동 숭실대학교</p></div>
					</div>
				</div>
	</footer>

	<!--모달 form-->
		<!--카메라 정보 수정 모달 -->
		<div class="modal fade" id="modal_camera_edit" tabindex="-1" role="dialog" aria-labelledby="modal_camera_edit_label" aria-hidden="true">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="modal_camera_edit_label"></h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		      	<div style="display:inline-block;"> 
		      	<img src="/static/img/modal_cafe_img.jpg" class="rounded float-left" alt="...">
		      	</div>

		      	<div class="input-group input-group-sm mb-3" >

		      		<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 25%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;">카메라 접속 확인</span>
						</div>
						  <input id="modal_camera_edit_curhost" type="text" class="form-control" aria-describedby="inputGroup-sizing-sm">
						   <div class="input-group-append" id="button-addon4">
						  <button id="modal_camera_edit_curhost_btn" class="btn btn-outline-secondary" type="button" onclick="check_camera_connection('edit')">Check</button>
						</div>
					</div>

		      		<div class="input-group-prepend" style="width : 25%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;">Mac Address</span>
						</div>
						  <input id="modal_camera_edit_mac_addr" type="text" class="form-control" aria-describedby="inputGroup-sizing-sm">
					</div>
					<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 25%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align:center; padding-top:11px;" >설명</span>
						</div>
						  <textarea id="modal_camera_edit_description" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" style="resize:none;" ></textarea>
					</div>
		        </form>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
		        <button type="button" class="btn btn-primary" id="modal_camera_edit_btn" data-dismiss="modal" data-pk="1" >변경사항 저장</button>
		      </div>
		    </div>
		  </div>
		</div>

		<!--카메라 추가 모달 -->
		<div class="modal fade" id="modal_camera_add" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title" id="exampleModalLabel">카메라 추가</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <form>
		        	  <div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 25%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;">카메라 접속 확인</span>
						</div>
						  <input id="modal_camera_add_curhost" type="text" class="form-control" aria-describedby="inputGroup-sizing-sm">
						   <div class="input-group-append" id="button-addon4">
						  <button id="modal_camera_add_curhost_btn" class="btn btn-outline-secondary" type="button" onclick="check_camera_connection('add')">Check</button>
						</div>
					</div>

		        	  <div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 25%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;">Mac Address</span>
						</div>
						  <input id="modal_camera_add_mac_addr" type="text" class="form-control" aria-describedby="inputGroup-sizing-sm">
					</div>
					<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 25%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align:center; padding-top:11px;" >설명</span>
						</div>
						  <textarea id="modal_camera_add_description" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" style="resize:none;"></textarea>
					</div>
		        </form>

		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="modal_camera_init()">닫기</button>
		        <button id ="modal_camera_add_btn" type="button" data-dismiss="modal" class="btn btn-primary">기기 추가</button>
		      </div>
		    </div>
		  </div>
		</div>

		<!--floor add btn 모달 -->
		<div class="modal fade" id="modal_floor" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		  <div class="modal-dialog" role="document" style="height:90%;">
		    <div class="modal-content" style="height:90%;">
		      <div class="modal-header">
		        <h5 class="modal-title" id="exampleModalLabel"></h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <form">
		        	<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 13%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;"> 층 이름</span>
						</div>
						  <input id="modal_floor_add_name" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" >
					</div>
					<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 13%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align:center;" > 층 </span>
						</div>
						  <input id="modal_floor_add_num" type="number" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
					</div>
					<div class="input-group input-group-sm mb-3">
			  			<div class="input-group-prepend" style="width : 13%; text-align: center;">
						    <span class="input-group-text" style="display:block; width:100%; padding-top:11px; text-align: center;" > 설명</span>
						</div>
						 <textarea class="form-control" id="modal_floor_add_description" style="resize:none;"></textarea>
					</div>
		      		
		      		<div class="container-fluid" style="padding:0;" >
		      			<div style="border : solid gray 1px; float:left; width:45%; height :300px; max-height:300px; display:inline-block; overflow: scroll;">
		      				<table class="table table-bordered table-hover" id="modal_floor_add_camera_list_left" style="border : none;">
		      					<thead class="thead-light" >
		      						<tr >
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">#</td>
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">설명</td>
		      						</tr>
		      					</thead>
		      					<tbody name="modal_floor_add_tbody_unused_camera">
		      					</tbody>
		      				</table>
		      			</div>
		      			<div style="min-width:1%;  max-width: 10%; width: 200px; min-height:300px; display: inline-block;">
		      				<i id="modal_floor_arrow_right_btn" type="button" class="fa fa-arrow-right" onclick='move_modal_floor_unused_used(0)' style="display: block; float: left; position:absolute; top:55%; left:49%;"></i>
		      				<i id="modal_floor_arrow_left_btn" type="button" class="fa fa-arrow-left" onclick='move_modal_floor_used_unused(0)' style="display: block; float:left; position:absolute; top:65%; left:49%;" ></i>
		      			</div>
		      				<div style="border : solid gray 1px; float:right; width:45%; height :300px; max-height:300px; display:inline-block; overflow: scroll;">
		      				<table class="table table-bordered table-hover" id="modal_floor_add_camera_list_right" style="border : none;">
		      					<thead class="thead-light" >
		      						<tr>
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">#</td>
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">설명</td>
		      						</tr>
		      					</thead>
		      					<tbody name="modal_floor_add_tbody_used_camera">
		      					</tbody>
		      				</table>
		      			</div>
		      		</div>

		        </form>
		      </div>
		      <div class="modal-footer">
		        <button id="modal_floor_add_close_btn" onclick="modal_floor_init('add')" type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
		        <button id ="modal_floor_add_btn" type="button" data-dismiss="modal" class="btn btn-primary"> 추가</button>
		      </div>
		    </div>
		  </div>
		</div>

		<!-- floor edit btn 모달-->
		<div class="modal fade" id="modal_floor_edit" tabindex="-1" role="dialog" aria-labelledby="modal_floor_edit_label" aria-hidden="true">∂
		  <div class="modal-dialog" role="document" style="height:90%;">
		    <div class="modal-content" style="height:90%;">
		      <div class="modal-header">
		        <h5 class="modal-title" id="modal_floor_edit_label"></h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <form>
		        	<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 13%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align: center;"> 층 이름</span>
						</div>
						  <input id="modal_floor_edit_name" type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" >
					</div>
					<div class="input-group input-group-sm mb-3" >
			  			<div class="input-group-prepend" style="width : 13%;">
						    <span class="input-group-text" style="display:block; width:100%; text-align:center;" > 층 </span>
						</div>
						  <input id="modal_floor_edit_num" type="number" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
					</div>
					<div class="input-group input-group-sm mb-3">
			  			<div class="input-group-prepend" style="width : 13%; text-align: center;">
						    <span class="input-group-text" style="display:block; width:100%; padding-top:11px; text-align: center;" > 설명</span>
						</div>
						 <textarea class="form-control" id="modal_floor_edit_description" style="resize:none;"></textarea>
					</div>
		      		<div class="container-fluid" style="padding:0;" >
		      			<div style="border : solid gray 1px; float:left; width:45%; height :300px; max-height:300px; display:inline-block; overflow: scroll;">
		      				<table class="table table-bordered table-hover" id="modal_floor_edit_camera_list_left" style="border : none;">
		      					<thead class="thead-light" >
		      						<tr>
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">#</td>
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">설명</td>
		      						</tr>
		      					</thead>
		      					<tbody name="modal_floor_edit_tbody_unused_camera">
		      					</tbody>
		      				</table>
		      			</div>
		      			<div style="min-width:1%;  max-width: 10%; width: 200px; min-height:300px; display: inline-block;">
		      				<i id="modal_floor_arrow_right_btn_2" type="button" class="fa fa-arrow-right" onclick='move_modal_floor_unused_used(1)' style="display: block; float: left; position:absolute; top:55%; left:49%;"></i>
		      				<i id="modal_floor_arrow_left_btn_2" type="button" class="fa fa-arrow-left" onclick='move_modal_floor_used_unused(1)' style="display: block; float:left; position:absolute; top:65%; left:49%;" ></i>
		      			</div>
		      				<div style="border : solid gray 1px; float:right; width:45%; height :300px; max-height:300px; display:inline-block; overflow: scroll;">
		      				<table class="table table-bordered table-hover" id="modal_floor_edit_camera_list_right" style="border : none;">
		      					<thead class="thead-light" >
		      						<tr style="background-color:black;">
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">#</td>
		      							<td style="background-color: #e9ecef; position:sticky; top:0;" class="td-sm">설명</td>
		      						</tr>
		      					</thead>
		      					<tbody name="modal_floor_edit_tbody_used_camera">

		      					</tbody>
		      				</table>
		      			</div>
		      		</div>

		        </form>
		      </div>
		      <div class="modal-footer">
		        <button id="modal_floor_edit_close_btn" onclick="modal_floor_init('edit')" type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
		        <button id ="modal_floor_edit_btn" type="button" data-floor_id="" data-dismiss="modal" class="btn btn-primary">수정 및 저장</button>
		      </div>
		    </div>
		  </div>
		</div>
		<!--모달 form 끝-->


<!--script start -->
	<script type="text/javascript">
		var page = 1;
		$(window).scroll(function() {
			if ($(window).scrollTop() == $(document).height() - $(window).height()) {
				console.log(++page);
				$("tbody").append('<tr><td>1<i style="margin:4px" class="fa fa-camera"></i></td><td>카메라1</td><td>창가 천장 위</td><td><i style="margin:4px" class="fa fa-edit"></i><i style="margin:4px" class="fa fa-trash"></i></td></tr>');
			}
		});

/*자바스크립트 함수 */

		/*카메라 리스트 생성 ,추가 함수*/
		function create_camera_info(data) {
			$('#tbody_camera').append('<tr id="tr_list_'+data.pk+'"><input type="hidden" data-pk="'+data.pk+'" data-cur_pic="'+data.cur_pic+'" data-mac_addr="'+data.mac_addr+'" data-cur_host="'+data.cur_host+'" data-description="'+data.description+'" data-store_id="'+data.store_id+'" data-floor_id="'+data.floor_id+'"><td class="clickable" onclick="move_page(this)" link="camera/'+data.pk+'"><i style="margin:4px" class="fa fa-camera"></i><a style="margin:4px; color:white;" href= "camera/'+data.pk+'">'+data.pk+'</a></td><td><i style="margin:4px" class="fa fa-eye"></i></td><td>'+data.mac_addr+'</td><td>'+data.description+'</td><td><i type="button" name="'+data.pk+'" data-toggle="modal" data-target="#modal_camera_edit"  style="margin:4px" class="fa fa-edit" id="td_camera_edit_button"><input type="hidden" name= "{{list.pk}}"></i><i style="margin:4px" class="fa fa-trash" name= "'+data.pk+'" id="td_camera_delete_button"></i></td></tr>');
		}

		/*floor 모달에서 카메라가 배정되는 floor_id를 수정해주는 함수 */
		function edit_floor_id(store_id,camera_list, floor_id) {
			$.ajax({
				url : "{% url 'watcher:ajax_edit_floor_id' %}",
				dataType:'json',
				type:'POST',
				data :{
					'csrfmiddlewaretoken' : "{{csrf_token}}",
					'store_id' : store_id,
					'camera_list[]' : camera_list,
					'floor_id' : floor_id,
				},success : function(data) {
					console.log("SUCCESS");
					var k = 0;
					console.log(data.length);
					$.each(data, function(index,element) {
						if(element.floor_id === null){element.floor_id = "None"}
						if(element.mac_addr === null) {element.mac_addr = "None"}
					});
					console.log("data_length:"+data.length);
					$('#tbody_camera').empty();
					for(var i =0; i < data.length; i++){create_camera_info(data[i]);}
				},
				error : function(error) {
					alert('add floor_ id error' + eval(error));
				}
			});
			$('#modal_floor_name').val('');
			$('#modal_floor_num').val('');
			$('#modal_floor_description').val('');
			$('#modal_tbody_unused_camera').empty();
			$('#modal_tbody_used_camera').empty();
		}

		/* floor 리스트 추가 함수 */
		function create_floor_info(data) {
			$('#tbody_floor').append('<tr id="tr_list_'+data.pk+'" data-store="'+data.store_id+'"><input type="hidden" data-pk="'+data.pk+'" data-name="'+data.name+'" data-num="'+data.floor_num+'" data-store_id="'+data.store_id+'" data-description="'+data.description+'" ><td id="c_num_'+data.pk+'">'+data.floor_num+'</td><td>'+data.name+'</td><td>'+data.description+'</td><td><i type="button" name="'+data.pk+'" data-toggle="modal" data-target="#modal_floor_edit"  style="margin:4px" class="fa fa-edit" id="td_floor_edit_button"><input type="hidden" name="'+data.pk+'"></i><i type="button" style="margin:4px" class="fa fa-trash" name="'+data.pk+'" id="td_floor_delete_button"></i></td></tr>');

		
		}

		/*floor 모달에서 floor_pk가 정해지지 않은 카메라 목록*/
		function create_unused_camera_table(list,flag) {
			$('tbody[name=modal_floor_'+flag+'tbody_unused_camera]').empty();
			console.log("start make unused_caemra_list");
			for( var i =0 ; i<list.length ; i++){
				console.log("in");
				console.log(list[i].dataset.pk);
				if(flag === "add") {
					$('tbody[name=modal_floor_add_tbody_unused_camera]').append('<tr data-pk="'+list[i].dataset.pk+'"><td class="td-sm"><input type="checkbox" data-pk="'+list[i].dataset.pk+'" name="unused_camera" style="margin:1%;" >'+list[i].dataset.pk+'</label></td><td class="td-sm">'+list[i].dataset.description+'</td><tr>');
				}
				else if( flag === "edit") {
					$('tbody[name=modal_floor_edit_tbody_unused_camera]').append('<tr data-pk="'+list[i].dataset.pk+'"><td class="td-sm"><input type="checkbox" name="unused_camera" style="margin:1%;" >'+list[i].dataset.pk+'</label></td><td class="td-sm">'+list[i].dataset.description+'</td><tr>');
				}
			}
		}

		/*floor 모달에서 floor_pk가 정해진 카메라 목록*/

		function create_used_camera_table(list) {
			$('tbody[name=modal_floor_edit_tbody_used_camera]').empty();
			console.log("start");
			for( var i =0 ; i<list.length ; i++){
				console.log("in");
				console.log(list[i].dataset.pk);
				$('tbody[name=modal_floor_edit_tbody_used_camera]').append('<tr data-pk="'+list[i].dataset.pk+'"><td class="td-sm"><input type="checkbox" name="used_camera" style="margin:1%;" >'+list[i].dataset.pk+'</label></td><td class="td-sm">'+list[i].dataset.description+'</td><tr>');
			}
		}


/*자바스크립트 함수 끝 */

	/* 검색기능 */
		$(document).ready(function(){
			$("#keyword").on("keyup", function() {
				var value = $(this).val().toLowerCase();
				$("tbody tr").filter(function() {
					$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
				});
			});
		});


	/* 카메라 테이블 >row > edit 버튼 기능 */
		$(document).on('click', '#td_camera_edit_button', function(e){
			var pk_check = $(this).attr('name');
			
			pk_check *=1;
			console.log(pk_check);
			$.ajax({
				url:"{% url 'watcher:ajax_get_camera_info' %}",
				dataType : 'json',
				type:'POST',
				data:{
					'pk': pk_check,
					'csrfmiddlewaretoken' : "{{csrf_token}}",
				},
				success:function(data){
					console.log(data)

					$('#modal_camera_edit_label').text(data.pk+"번 카메라");
					$('#modal_camera_edit_description').val(data.description);
					$('#modal_camera_edit_mac_addr').val(data.mac_addr);
					$('#modal_camera_edit_curhost').val(data.cur_host);
					$('#modal_camera_edit_btn').attr('name',pk_check);

				},
				error: function (error) {
						alert('td_camera_edit_button error; ' + eval(error));
					}
			});
		});

		/* 테이블 row 삭제 버튼 기능 */
		$(document).on('click', '#td_camera_delete_button', function(e) {
			var pk = $(this).attr('name');
			var store_id = $('tbody').attr('name');

			console.log("삭제할 store_id :"+store_id);
			if(confirm("삭제 하시겠습니까?")) {
				$.ajax({
						url:"{% url 'watcher:ajax_delete_camera_list' %}",
						type : 'GET',
						data:{
							'pk': pk,
							'store_id' : store_id,
						},
						success : function(data){
							$('#tr_list_'+pk).remove();
						},
						error: function (error) {
						alert('td_delete_button error; ' + eval(error));
					}

				});
				return true;
			}
			else {
				return false;
			}
		});

		/*카메라 추가 기능 in 모달 */
		$(document).on('click', '#modal_camera_add_btn', function(e) {
			var cur_host = $('#modal_camera_add_curhost').val();
			var camera_description = $('#modal_camera_add_description').val();
			var store_id = "{{store.pk}}"
			
			if (confirm('정말 추가 하시겠습니까?')) {

				
				console.log(camera_description);
				console.log("{{store_id}}");
				$.ajax({
					url: "{% url 'watcher:ajax_add_camera_info' %}",
					dataType : "json",
					data: {
						'description' : camera_description,
						'store_id' : store_id,
						'cur_host' : cur_host,
					},
					type : 'GET',
					success: function(data) {
						console.log('save')
						if(data.floor_id === null){data.floor_id = "None"}
						if(data.mac_addr === null) {data.mac_addr = "None"}
						create_camera_info(data);
						
					},
					error: function (error) {
						alert('error; ' + eval(error));
					}

				});
				return true;
			}
			else
			{
				return false;
			}

		
		});

		/*카메라 정보 수정 버튼*/
		$(document).on('click', '#modal_camera_edit_btn', function(e) {
			var mac_addr = $('#modal_camera_edit_mac_addr').val();
			var description = $('#modal_camera_edit_description').val();
			var cur_host = $('#modal_camera_edit_curhost').val();
			var pk = $(this).attr('name');
			var store_id = "{{store.pk}}"

			console.log("store_pk : "+store_id);

			if(confirm("수정 하시겠습니까?")){
				$.ajax({
					url : "{% url 'watcher:ajax_edit_camera_info' %}",
					dataType : 'json',
					type : 'GET',
					data : {
						'store_id' : store_id,
						'pk' : pk,
						'mac_addr' : mac_addr,
						'description' : description,
						'cur_host' : cur_host,

					},
					success : function(data) {
						$('#tbody_camera').empty();
						for(var i = 0; i < data.length; i++){
							if(data[i].floor_id === null){data[i].floor_id = "None"}
							if(data[i].mac_addr === null){data[i].mac_addr = "None"}
							create_camera_info(data[i]);
						}

					},
					error : function(error) {
						alert('카메라 수정에러' + eval(error));
					}
				});
				return true;
			}
			else
			{
				return false;
			}
		});

		//카메라 연결 테스트 버튼 
		function check_camera_connection(type) {
			var cur_host = $('#modal_camera_'+type+'_curhost').val();
			console.log(cur_host);

				$.ajax({
					url: "{% url 'watcher:ajax_check_camera_connection' %}",
					type : 'GET',
					data : {
						'cur_host' : cur_host,
					},
					success : function(data) {
						alert(data)
					},
				});
		}
		//카메라 연결 테스트 확인 
		$(document).ready(function(){
			var camera_list = new Array(); 
			var cur_host;
			var pk;

			camera_list = $('#tbody_camera').find("tr > input");
			for( var i=0 ; i < camera_list.length ; i++) {
				cur_host = camera_list[i].dataset.cur_host;
				pk = camera_list[i].dataset.pk;
				$.ajax({
					url : "{% url 'watcher:ajax_check_camera_connection_table' %}",
					type : 'GET',
					data : {
						'cur_host' : cur_host,
						'pk' : pk,
					},success : function(data) {
						console.log(data);
						if(data.con == 'good') {
							$('.td_camera_'+data.pk).html('<i style="margin:4px" class="fa fa-eye"></i>');
						}
						else {
							$('.td_camera_'+data.pk).html('<i style="margin:4px" class="fa fa-eye-slash"></i>');	
						}
					},
				});
			}
		});

			$(document).ready(setInterval(function(){
			var camera_list = new Array(); 
			var cur_host;
			var pk;

			camera_list = $('#tbody_camera').find("tr > input");
			for( var i=0 ; i < camera_list.length ; i++) {
				cur_host = camera_list[i].dataset.cur_host;
				pk = camera_list[i].dataset.pk;
				$.ajax({
					url : "{% url 'watcher:ajax_check_camera_connection_table' %}",
					type : 'GET',
					data : {
						'camera_ip' : cur_host,
						'pk' : pk,
					},success : function(data) {
						console.log(data);
						if(data.con == 'good') {
							$('.td_camera_'+data.pk).html('<i style="margin:4px" class="fa fa-eye"></i>');
						}
						else {
							$('.td_camera_'+data.pk).html('<i style="margin:4px" class="fa fa-eye-slash"></i>');	
						}
					},
				});
			}
		},36000));



		/* floor 추가 modal 버튼 */
		$(document).on('click', '#add_floor_button',function(e) {
			var list = $('#tbody_camera > tr > input[data-floor_id=None]'); //카메라리스트 중에 floor_id가 배정 안된 카메라목록
			console.log(list.length +"개의 카메라가 층이 정해져 있지 않음");
			$('tbody[name=modal_tbody_unused_camera]').empty();
			console.log("start");
			create_unused_camera_table(list,"add");
		});

		$(document).on('click', '#modal_floor_add_btn', function(e) {
			var store_id = "{{store.pk}}"
			var floor_name = $('#modal_floor_add_name').val();
			var floor_num = $('#modal_floor_add_num').val();
			var description = $('#modal_floor_add_description').val();
			var floor_id;

			if(confirm("정말 추가 하시겠습니까?")) {

				var camera_checked = $('input[name=used_camera]').parent().parent();
				var camera_list = Array();
				for(var i = 0; i < camera_checked.length; i++) {
					camera_list.push(camera_checked[i].dataset.pk);
				}
				jQuery.ajaxSettings.traditional = true;

				$.ajax({
					url : "{% url 'watcher:ajax_add_floor_info' %}",
					dataType : "json",
					type :'GET',
					data : {
						'store_id' : store_id,
						'floor_name' : floor_name,
						'floor_num' : floor_num,
						'description' : description,
						'camera_list[]' : camera_list,
					},
					success : function(data) {
						console.log("floor pk :"+data.pk);
						create_floor_info(data);
						floor_id = data.pk;

						var camera_checked = $('input[name=used_camera]').parent().parent();
						var camera_list = Array();
						for(var i = 0; i < camera_checked.length; i++) { camera_list.push(camera_checked[i].dataset.pk);}
						edit_floor_id(store_id,camera_list,floor_id);
					},
					error: function (error) {
							alert('error; ' + eval(error));
					}
				});
				return true;
			}
			else
			{
				console.log("false");
				return false
			}

		});

		/* floor 추가 모달에서 카메라 이동버튼 이벤트*/
		function move_modal_floor_unused_used(data) {
			console.log("move_modal_floor_unused -> used");
			var type;
			if(data){type="edit"}
				else{type="add"}

			$('input[name=unused_camera]:checked').each(function(index,element){
				console.log("index"+$(this).attr('data-pk'));
				$(this).parent().parent().remove();
				$(this).prop('checked',false);
				$(this).attr('name','used_camera');
				$('tbody[name=modal_floor_'+type+'_tbody_used_camera]').append($(this).parent().parent().eq(0));
			});
		}

		function move_modal_floor_used_unused(data) {
			var type;

			if(data){type="edit"}
				else{type="add"}

			$('input[name=used_camera]:checked').each(function(index,element){
				console.log("index"+index);
				$(this).parent().parent().remove();
				$(this).prop('checked',false);
				$(this).attr('name','unused_camera');
				$('tbody[name=modal_floor_'+type+'_tbody_unused_camera]').append($(this).parent().parent().eq(0));
			});


		}

		/* floor delete 버튼 */
		$(document).on('click','#td_floor_delete_button',function(e) {
			var floor_id = $(this).attr('name');
			var store_id = "{{store.pk}}";

			console.log(floor_id);
			if(confirm("삭제 하시겠습니까?")) {
				$.ajax({
						url:"{% url 'watcher:ajax_delete_floor_info' %}",
						type : 'GET',
						dataType : 'json',
						data:{
							'floor_id' : floor_id,
							'store_id' : store_id,
						},
						success : function(data){
							console.log("floor_info delete success")
							$('#tr_list_'+floor_id).remove();
							$.each(data, function(index,element) {
							if(element.floor_id === null){element.floor_id = "None"}
							if(element.mac_addr === null){element.mac_addr = "None"}
						});
							$('#tbody_camera').empty();
							for(var i =0; i < data.length; i++){
								create_camera_info(data[i]);
							}
						},
						error: function (error) {
						alert('td_delete_button error; ' + eval(error));
					}

				});
				return true;
			}
			else {
				return false;
			}
		});

		/* floor edit 버튼 */
		$(document).on('click', '#td_floor_edit_button', function(e) {
			var floor_pk = $(this).parent().parent().children().eq(0).attr('data-pk');
			var floor_name = $(this).parent().parent().children().eq(0).attr('data-name');
			var floor_num = $(this).parent().parent().children().eq(0).attr('data-num');
			var floor_description = $(this).parent().parent().children().eq(0).attr('data-description');
			$('#modal_floor_edit_btn').attr('data-floor_id',floor_pk);
			console.log(floor_pk);
			$('#modal_floor_edit_label').html(floor_num+"층 ("+floor_name+")");
			$('#modal_floor_edit_name').val(floor_name);
			$('#modal_floor_edit_num').val(floor_num);
			$('#modal_floor_edit_description').val(floor_description);

			var unused_list = $('#tbody_camera > tr > input[data-floor_id=None]'); //카메라리스트 중에 floor_id가 배정 안된 카메라목록
			console.log(unused_list.length +"개의 카메라가 층이 정해져 있지 않음");
			create_unused_camera_table(unused_list,"edit"); 

			var used_list = $('#tbody_camera > tr > input[data-floor_id='+floor_pk+']');
			console.log(used_list.length +"개의 카메라가 층이 정해져 있지 않음");
			create_used_camera_table(used_list); 
		});

		/*floor edit 모달에서 저장 버튼 누를경우*/
		$(document).on('click', '#modal_floor_edit_btn', function(e) {

			var floor_id = $(this).attr('data-floor_id');
			console.log("f_id"+floor_id);
			if(confirm("정말 추가 하시겠습니까?")) {

				var floor_name = $('#modal_floor_edit_name').val();
				var floor_num = $('#modal_floor_edit_num').val();
				var floor_description =$('#modal_floor_edit_description').val();	

				var camera_used = $('input[name=used_camera]').parent().parent();
				var camera_unused = $('input[name=unused_camera]').parent().parent();
				var store_id ="{{store.pk}}";
				
				var camera_used_list = Array();
				var camera_unused_list = Array();
				
				console.log("camera_used: "+camera_used.length);
				console.log("camera_unused: "+camera_unused.length);
				for(var i = 0; i < camera_used.length; i++){
					camera_used_list.push(camera_used[i].dataset.pk);
					console.log("used : "+camera_used[i].dataset.pk);
				}
				console.log("------");
				for(var i = 0; i < camera_unused.length; i++){
					camera_unused_list.push(camera_unused[i].dataset.pk);
					console.log("unused : "+camera_unused[i].dataset.pk);
				}	

				jQuery.ajaxSettings.traditional = true;

				$.ajax({
					url : "{% url 'watcher:ajax_edit_floor_camera_list' %}",
					dataType : 'json',
					type : 'GET',
					data : {
						'camera_used[]' : camera_used_list,
						'camera_unused[]' : camera_unused_list,
						'store_id' : store_id,
						'floor_id' : floor_id,
						'floor_name' : floor_name,
						'floor_num' : floor_num,
						'floor_description' : floor_description,
					},
					success : function(data) {
						$.each(data, function(index,element) {
							if(element.floor_id === null){element.floor_id = "None"}
							if(element.mac_addr === null){element.mac_addr = "None"}
						});
						$('#tbody_camera').empty();
						for(var i =0; i < data.length; i++){create_camera_info(data[i]);}

						modal_floor_init('edit');	
						/*floor 정보 수정후 해당 row정보 만 바꿔줌 */
						$('#table_floor_tr_'+floor_id).contents().empty(); 
						$('#table_floor_tr_'+floor_id).html('<input type="hidden" data-pk="'+floor_id+'" data-name="'+floor_name+'" data-num="'+floor_num+'" data-store_id="'+store_id+'" data-description="'+floor_description+'" ><td>'+floor_num+'</td><td>'+floor_name+'</td><td>'+floor_description+'</td><td><i type="button" name="'+floor_id+'" data-toggle="modal" data-target="#modal_floor_edit"  style="margin:4px" class="fa fa-edit" id="td_floor_edit_button"><input type="hidden" name= "'+floor_id+'"></i><i type="button" style="margin:4px" class="fa fa-trash" name= "'+floor_id+'" id="td_floor_delete_button"></i></td>');
					},
					error : function(error) {
						alert('modal_floor_edit_btn error; ' + eval(error));
					},
				});
				return true;
			}
			else {
				return false;
			}

		});
		/*모달 종료시 데이터 초기화 */
			/*모달창에서 esc누를경우 */
			$(document).on('keydown', function(e) {
				if (e.keyCode == 27) {
					modal_floor_init('add');
					modal_floor_init('edit');
					modal_camera_init();
				}
			});

		function modal_camera_init() {
			$('#modal_camera_add_description').val('');
			$('#modal_camera_add_mac_addr').val('');
			$('#modal_camera_add_curhost').val('');
		}

		function modal_floor_init(type) {

			if(type === "edit"){
				console.log("close :"+type);
				$('tbody[name=modal_floor_'+type+'_tbody_unused_camera]').empty();
				$('tbody[name=modal_floor_'+type+'_tbody_used_camera]').empty();
				return false;
			}
			else{
				console.log("close :"+type);
				$('#modal_floor_'+type+'_name').val('');
				$('#modal_floor_'+type+'_num').val('');
				$('#modal_floor_'+type+'_description').val('');
				$('tbody[name=modal_floor_'+type+'_tbody_unused_camera]').empty();
				$('tbody[name=modal_floor_'+type+'_tbody_used_camera]').empty();
			}
		}
		//move to camera seat data edit page - YR
		function move_page(el){
    		var addr = $(el).attr('link')
			location.href = addr
  		}	


		$('#footer_copyright>ul').hide();
  		$(document).on('mouseleave', 'footer',function(e){
  				$('#footer_copyright>ul').hide();
  		});
  		$(document).on('mouseenter', 'footer',function(e){
  				$('#footer_copyright>ul').show();
  		});
	</script>


<!--script end-->
</body>
</html>
